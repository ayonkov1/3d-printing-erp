services:
    # The PostgreSQL Database Service
    db:
        image: postgres:15-alpine
        container_name: postgres_db
        restart: always
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        # ports:
        # Expose PostgreSQL to host for local development
        # - '5432:5432'
        volumes:
            # This persists database data on your local machine
            - postgres_data:/var/lib/postgresql/data
            # This runs our initialization script on the first startup
            - ./backend/app/sql/db_setup.sql:/docker-entrypoint-initdb.d/db_setup.sql
        networks:
            - app-network

    # FastAPI Backend Service
    backend:
        build: ./backend
        container_name: fastapi_backend
        environment:
            # Database Configuration
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_HOST: db
            POSTGRES_PORT: ${POSTGRES_PORT:-5432}
            POSTGRES_DB: ${POSTGRES_DB}
            # JWT Authentication
            SECRET_KEY: ${SECRET_KEY}
            # App Configuration
            DEBUG: ${DEBUG:-false}
            # CORS Configuration
            CORS_ORIGINS: ${CORS_ORIGINS:-*}
            # OpenAI Configuration (optional)
            OPENAI_API_KEY: ${OPENAI_API_KEY:-}
        depends_on:
            - db
        networks:
            - app-network

    # The React Frontend & NGINX Reverse Proxy Service
    frontend:
        build: ./frontend
        container_name: react_frontend
        expose:
            - '80'
        depends_on:
            - backend
        networks:
            - app-network
            - coolify

# Define the network and volume
networks:
    app-network:
        driver: bridge
    coolify:
        external: true

volumes:
    postgres_data:
        driver: local
